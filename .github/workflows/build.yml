---
name: Build simple

on:
  push:
    branches:
      - "**"
  pull_request:
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  diagnostics:
    name: "Diagnostics"
    runs-on: ubuntu-latest
    steps:
      - name: Check GitHub Status
        uses: crazy-max/ghaction-github-status@df4d23a4977438215339cf0fafceda8d9af8a0e5 # tag=v4.0.0
        with:
          overall_threshold: major
          packages_threshold: major_outage

      - name: Dump context
        uses: crazy-max/ghaction-dump-context@8b55fa205ab4530d36f787a4de1009afaaa7f3b4 # tag=v2.1.0

  build-image:
    name: "Build image"
    runs-on: ubuntu-latest
    timeout-minutes: 3
    strategy:
      matrix:
        platform:
          [
            linux/amd64,
            linux/arm/v6,
            linux/arm/v7,
            linux/arm64,
            linux/ppc64le,
            linux/s390x,
          ]
    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # tag=v4.1.0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3 # tag=v3.0.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # tag=v3.0.0

      - name: Clean variables
        id: clean
        run: |
          echo image_archive_name_stem=$(echo "${{ matrix.platform }}" | sed -e 's/[^a-zA-Z0-9._-]/_/g') >> $GITHUB_OUTPUT

      - name: Build image for archive
        uses: docker/build-push-action@0565240e2d4ab88bba5387d719585280857ece09 # tag=v5.0.0
        with:
          context: .
          file: ./Dockerfile
          outputs: type=docker,dest=/tmp/${{ steps.clean.outputs.image_archive_name_stem }}.tar
          platforms: ${{ matrix.platform }}
          push: false
